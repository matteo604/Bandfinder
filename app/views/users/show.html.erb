<div class="container">
  <div class="banner" style="background-image: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url(<%= asset_path('profile-banner.jpg') %>);"></div>

  <div class="container profile_banner">
    <div class="mb-3">
      <% if @user.photo.attached? %>
        <%= image_tag @user.photo, alt: "#{@user.first_name} #{@user.last_name}", class: "profile_image" %>
      <% else %>
        <%= image_tag "default-profile-image.jpg", alt: "default profile image", class: "profile_image" %>
      <% end %>
    </div>

    <div class="row border solid">
      <div class="col-3">
        <h2 class="m-3"><%= @user.first_name %> <%= @user.last_name %></h2>
      </div>

      <div class="col-9 text-end">
        <h4 class="m-3"> Member since: <%= @user.created_at.strftime("%b %d, %Y") %></h4>
      </div>
    </div>
  </div>

  <div class="row mt-4 d-flex justify-content-center">
   <div class="gap-5">
    <div class="user_details_card fs-4 d-flex flex-column">
      <div class="d-flex justify-content-between align-items-center">
        <h2>My Details</h2>
        <%if current_user == @user %>
          <%= link_to edit_user_path(@user), class: "ms-auto" do %>
            <i class="fa-solid fa-pencil fs-4"></i>
          <% end %>
        <% end %>
      </div>

      <div class="p-2 border-top"><i class="fa-solid fa-phone"></i> <%= @user.telephone_number %></div>
      <div class="p-2"><i class="fa-solid fa-location-dot"></i> <%= @user.address %></div>
      <div class="p-2"><i class="fa-regular fa-envelope"></i> <%= @user.email %></div>

      <div class="p-2 border-bottom">
        <i class="fa-solid fa-drum fs-3"></i>
        <%= @user.instruments.join(", ") %>
      </div>
    </div>
   </div>

  </div>

  <div class="user-info mt-3">
    <!-- Add a button to start or continue a chat with the user -->
    <% if current_user != @user %>
      <%= button_to 'Message this user', chats_path(chat: { band_leader_id: @user.id }), method: :post, class: "btn btn-primary" %>
    <% end %>

    <% if current_user != @user && current_user.band_id %>
      <% if current_user.band.join_requests.where(user_id: @user.id).length > 0 %>
        <p class="mt-3"> Request already sent </p>
      <% else %>
        <%= button_to "Ask #{@user.first_name} to join my band", user_join_requests_path(user_id: @user.id, join_request: { join_type: "band_to_user" }), method: :post, class: "btn btn-primary mt-3" %>
      <% end %>
    <% end %>
  </div>
  <% if current_user == @user %>
    <h3>Pending Join Requests</h3>
    <% if @join_requests.any? %>
      <% @join_requests.each do |request| %>
        <div class="card mb-3 shadow-sm">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <h5 class="card-title mb-1"><%= request.user.first_name %> <%= request.user.last_name %></h5>
              <p class="mb-0 text-muted">Requested to join on <%= request.created_at.strftime("%B %d, %Y") %></p>
            </div>
            <div class="btn-group">
              <!-- Pulsante per accettare la richiesta di partecipazione -->
              <%= button_to 'Accept Request', accept_user_join_request_path(user_id: @user.id, id: request.id),
                            method: :patch, class: "btn btn-success", data: { confirm: 'Are you sure you want to accept this request?' } %>

              <!-- Pulsante per rifiutare la richiesta di partecipazione -->
              <%= button_to 'Decline Request', decline_user_join_request_path(user_id: @user.id, id: request.id),
                            method: :patch, class: "btn btn-danger", data: { confirm: 'Are you sure you want to decline this request?' } %>
            </div>
          </div>
        </div>
      <% end %>
    <% else %>
      <p class="text-muted">No pending requests at the moment.</p>
    <% end %>
  <% end %>
</div>
